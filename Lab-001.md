Decompilation and Analysis 
==========================

**1.) - Download the APK**

```
➜  ~  git clone https://github.com/VerSprite/BSidesSF-2015
Cloning into 'BSidesSF-2015'...
remote: Counting objects: 93, done.
remote: Compressing objects: 100% (38/38), done.
remote: Total 93 (delta 3), reused 0 (delta 0), pack-reused 37
Unpacking objects: 100% (93/93), done.
Checking connectivity... done.
➜  ~  cd BSidesSF-2015 
➜  BSidesSF-2015 git:(master) cd app/
➜  app git:(master) ls -la
total 3592
drwxr-xr-x  9 rotlogix  staff     306 Apr  7 10:52 .
drwxr-xr-x  7 rotlogix  staff     238 Apr  7 10:52 ..
-rw-r--r--  1 rotlogix  staff       7 Apr  7 10:52 .gitignore
-rw-r--r--  1 rotlogix  staff  907915 Apr  7 10:52 app-release.apk
-rw-r--r--  1 rotlogix  staff    7223 Apr  7 10:52 app.iml
-rw-r--r--  1 rotlogix  staff     587 Apr  7 10:52 build.gradle
-rw-r--r--  1 rotlogix  staff  907915 Apr  7 10:52 crackme.apk
-rw-r--r--  1 rotlogix  staff     666 Apr  7 10:52 proguard-rules.pro
drwxr-xr-x  4 rotlogix  staff     136 Apr  7 10:52 src
➜  app git:(master) 


```

**2.) - Decompile the APK with apktool - http://ibotpeaches.github.io/Apktool/**

```
➜  app git:(master) java -jar ~/Tools/mobile/android/apktool/apktool_2.0.0rc4.jar -r d crackme.apk 
I: Using Apktool 2.0.0-RC4 on crackme.apk
I: Loading resource table...
I: Copying raw resources...
I: Baksmaling classes.dex...
I: Copying assets and libs...
I: Copying unknown files...
I: Copying original files...
```
``-r`` disregards decoding resources

APK Directory Structure
-----------------------

```/res``` - Directory containing resources that are not compiled

```
➜  crackme git:(master) ✗ ls -R | grep '/res'
./res:
./res/anim:
./res/color:
./res/drawable:
./res/drawable-hdpi-v4:
./res/drawable-ldrtl-hdpi-v17:
./res/drawable-ldrtl-mdpi-v17:
./res/drawable-ldrtl-xhdpi-v17:
./res/drawable-ldrtl-xxhdpi-v17:
./res/drawable-ldrtl-xxxhdpi-v17:
./res/drawable-mdpi-v4:
./res/drawable-v21:
./res/drawable-xhdpi-v4:
./res/drawable-xxhdpi-v4:
./res/drawable-xxxhdpi-v4:
./res/layout:
./res/layout-v11:
./res/layout-v21:
./res/menu:
./res/mipmap-hdpi-v4:
./res/mipmap-mdpi-v4:
./res/mipmap-xhdpi-v4:
./res/mipmap-xxhdpi-v4:
./smali/android/support/v4/content/res:
```

```META-INF``` - Usually contains the Manifest, and Application Certifcate

```
➜  crackme git:(master) ✗ ls -R | grep '/META-INF'
./original/META-INF:
```

```lib``` - Directory containing compiled shared objects broken down into their specific architecture - ex: ```armeabi, armeabi-v7a``` - *armeabi - "ARM Embedded Application Binary Interface"*

```assets``` - Directory containing assets that can be accessed by the AssetManager

```AndroidManifest.xml``` - Contains application, permission, and component definitions and declarations

```classes.dex``` - Compiled DEX executable

```resources.arsc``` - Precompiled resources 

-----------------------------------------------------------------------------------------------------------------------------

The output of apktool will breakout the APK structure a bit different: 

```
➜  crackme git:(master) ✗ ls
AndroidManifest.xml apktool.yml         original            res                 resources.arsc      smali
```

```/smali``` - Contains the disassembled format for the Dalvik bytecode

```./com:
versprite

./com/versprite:
crackme

./com/versprite/crackme:
BuildConfig.smali   R$anim.smali        R$color.smali       R$id.smali          R$menu.smali        R$style.smali       emulator
KeyActivity$1.smali R$attr.smali        R$dimen.smali       R$integer.smali     R$mipmap.smali      R$styleable.smali   generate
KeyActivity.smali   R$bool.smali        R$drawable.smali    R$layout.smali      R$string.smali      R.smali

./com/versprite/crackme/emulator:
Detect.smali

./com/versprite/crackme/generate:
Generate.smali         GenerateReceiver.smali
```
apktool leverages - https://code.google.com/p/smali/ - for this task

**03.) Using Androguard for Analysis**

Documentation: http://doc.androguard.re/html/index.html

Androguard is a great tool to automate APK analysis.  We will be using 'Androlyze" for most of the labs, which provides interactive analysis.

```
➜  app git:(master) ✗ python ~/Tools/mobile/android/androguard/androlyze.py -s
Androlyze version 2.0
In [1]: 
```

We can use AnalyzeAPK() to perform all of heavy lifting for us: 

```
In [1]: a,d,dx = AnalyzeAPK("crackme.apk")
In [2]:
```
This returns the APK, DalvikVMFormat, and VMAnalysis objects.

**APK** - has access to all elements in an APK file

**DalvikVMFormat** - can parse a classes.dex file fo an APK

**VMAnalysis** - analyses a dex file

We can now use the class methods from the APK object to perform basic enumeration over permissions and components: 

**Activities**

```
In [2]: a.get_activities()
Out[2]: ['com.versprite.crackme.KeyActivity']
```

If you type a. [tab] -> androlyze will display a list of available method

```
In [3]: a.get
a.get_AndroidManifest        a.get_certificate            a.get_files                  a.get_max_sdk_version        a.get_services
a.get_activities             a.get_details_permissions    a.get_files_crc32            a.get_min_sdk_version        a.get_signature
a.get_android_manifest_axml  a.get_dex                    a.get_files_information      a.get_package                a.get_signature_name
a.get_android_manifest_xml   a.get_element                a.get_files_types            a.get_permissions            a.get_target_sdk_version
a.get_android_resources      a.get_elements               a.get_intent_filters         a.get_providers              
a.get_androidversion_code    a.get_file                   a.get_libraries              a.get_raw                    
a.get_androidversion_name    a.get_filename               a.get_main_activity          a.get_receivers  
```

We are not requesting any special permissions in this application or have any other component besides the declared activity, but here are methods you will care about with a much larger application: 

**a.get_services()** -> Services

**a.get_receivers()** -> Broadcast Receivers

**a.get_providers()** -> Content Providers

**a.get_permissions()** -> Permissions
